[{"id":"35f2d326.881a9c","type":"tab","label":"Utilities","disabled":false,"info":""},{"id":"42a08664.fa205","type":"tab","label":"Motion Detection","disabled":false,"info":""},{"id":"c210a0c6.d2662","type":"tab","label":"Climate Data","disabled":false,"info":""},{"id":"98938126.60692","type":"tab","label":"Status","disabled":false,"info":""},{"id":"40f06183.fb05b","type":"tab","label":"Information","disabled":false,"info":""},{"id":"e4bbc226.91eb88","type":"tab","label":"VicRoads Traffic","disabled":false,"info":""},{"id":"f5277bd.7bb7c08","type":"tab","label":"Weather","disabled":false,"info":""},{"id":"f684442a.aa32b","type":"tab","label":"Notifications","disabled":false,"info":""},{"id":"e811d034.2110a","type":"ibmiot","z":"","name":"DeskBuddy IoT","keepalive":"60","domain":"","cleansession":true,"appId":"","shared":false},{"id":"a7b37d5.92696","type":"wiotp-credentials","z":"","name":"","org":"e4c52s","serverName":"","devType":"esp8266","devId":"nodemcu1001","keepalive":"60","cleansession":true,"tls":"","usetls":false},{"id":"5dbe8911.6bafb8","type":"dashDB","z":"","hostname":"bluemix05.bluforcloud.com","db":"BLUDB","port":"50000","name":"BluemixDashDB"},{"id":"2e744af2.fb5556","type":"twitter-credentials","z":"","screen_name":"@tonykambo"},{"id":"9df6082c.b936e","type":"ibmiot in","z":"35f2d326.881a9c","authentication":"apiKey","apiKey":"e811d034.2110a","inputType":"evt","deviceId":"","applicationId":"","deviceType":"+","eventType":"debug","commandType":"","format":"+","name":"Debug Messages","service":"registered","allDevices":true,"allApplications":"","allDeviceTypes":true,"allEvents":false,"allCommands":"","allFormats":true,"qos":0,"x":160,"y":120,"wires":[["4665e.f17a99a2"]]},{"id":"9f5038d1.8284f8","type":"debug","z":"35f2d326.881a9c","name":"","active":true,"console":"false","complete":"false","x":571.5,"y":135,"wires":[]},{"id":"4665e.f17a99a2","type":"function","z":"35f2d326.881a9c","name":"","func":"var debugString = msg.payload.d.message;\n\nmsg.payload = debugString;\n\nreturn msg;","outputs":1,"noerr":0,"x":364.5,"y":133,"wires":[["9f5038d1.8284f8"]]},{"id":"76b2013d.e624a8","type":"ibmiot in","z":"42a08664.fa205","authentication":"apiKey","apiKey":"e811d034.2110a","inputType":"evt","deviceId":"","applicationId":"","deviceType":"+","eventType":"motion","commandType":"","format":"json","name":"Motion Event","service":"registered","allDevices":true,"allApplications":"","allDeviceTypes":true,"allEvents":false,"allCommands":"","allFormats":true,"qos":0,"x":170,"y":100,"wires":[["e76af660.7f467"]]},{"id":"e76af660.7f467","type":"debug","z":"42a08664.fa205","name":"Motion Event debug","active":true,"console":"false","complete":"payload","x":488,"y":88,"wires":[]},{"id":"4accf146.ee9f48","type":"ibmiot in","z":"c210a0c6.d2662","authentication":"apiKey","apiKey":"e811d034.2110a","inputType":"evt","deviceId":"","applicationId":"","deviceType":"+","eventType":"temp","commandType":"","format":"json","name":"Temperature Messages","service":"registered","allDevices":true,"allApplications":"","allDeviceTypes":true,"allEvents":false,"allCommands":"","allFormats":true,"qos":0,"x":140,"y":140,"wires":[["286f8fe6.7f85f8","bb9b84d5.a95e48"]]},{"id":"286f8fe6.7f85f8","type":"function","z":"c210a0c6.d2662","name":"Decode Climate Message","func":"var temperature = msg.payload.d.temperature;\nvar humidity = msg.payload.d.humidity;\nvar heatIndex = msg.payload.d.heatIndex;\nvar deviceId = msg.payload.d.deviceId;\n\n//\"Temp=\"+temperature+\"C Humidity=\"+humidity+\"% HeatIndex=\"+heatIndex+\"C\";\n\n\n// prepare SQL for database insertion\n\n\n\nfunction melbourneCurrentLocalTimestamp() {\n    var d = new Date();\n    var current_utc_offset = d.getTimezoneOffset();\n    d.setMinutes(d.getMinutes() + current_utc_offset);\n    d.setMinutes(d.getMinutes() + 10*60);\n    return d;\n}\n\nvar newDate = melbourneCurrentLocalTimestamp();\n\nvar year = newDate.getFullYear();\nvar month = newDate.getMonth();\nvar day = newDate.getDate();\nvar hour = newDate.getHours();\nvar min = newDate.getMinutes();\nvar sec = newDate.getSeconds();\nvar dateStr = \"\"+year+\"-\"+month+\"-\"+day+\"-\"+hour+\":\"+min+\":\"+sec;\n\nvar insertSQL = \"INSERT INTO CLIMATE (DEVICEID,DATEMEASURED,TEMPERATURE,HUMIDITY,HEATINDEX) \";\nvar valuesSQL = \"VALUES ('\"+deviceId+\"',TIMESTAMP_FORMAT('\"+dateStr+\"','YYYY-MM-DD-HH24:MI:SS'),\"+temperature+\",\"+humidity+\",\"+heatIndex+\");\";\n\nmsg.payload = insertSQL+valuesSQL;\n\nreturn msg;","outputs":1,"noerr":0,"x":481.5,"y":141,"wires":[["8210e038.df6248"]]},{"id":"bb9b84d5.a95e48","type":"debug","z":"c210a0c6.d2662","name":"Raw Temp Msgs","active":true,"console":"false","complete":"payload","x":393,"y":61,"wires":[]},{"id":"8210e038.df6248","type":"dashDB in","z":"c210a0c6.d2662","dashDB":"5dbe8911.6bafb8","service":"_ext_","query":"","params":"","name":"","x":681,"y":257,"wires":[["3ab25f82.46085"]]},{"id":"3ab25f82.46085","type":"debug","z":"c210a0c6.d2662","name":"","active":true,"console":"false","complete":"false","x":851,"y":192,"wires":[]},{"id":"b6fec28.4f4f9c","type":"ibmiot out","z":"98938126.60692","authentication":"apiKey","apiKey":"e811d034.2110a","outputType":"cmd","deviceId":"nodemcu1001","deviceType":"esp8266","eventCommandType":"indicator","format":"json","data":"{\"status\":\"away\"}","qos":0,"name":"IBM IoT","service":"registered","x":700,"y":460,"wires":[]},{"id":"acfe8571.bcf23","type":"inject","z":"98938126.60692","name":"Away","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":155,"y":240,"wires":[["28443df5.09bcb2"]]},{"id":"28443df5.09bcb2","type":"function","z":"98938126.60692","name":"","func":"//msg.payload = JSON.stringify({\"deviceStatus\":\"away\"});\nmsg.payload = {\n    \"status\":\"away\"\n};\n//msg.payload = \"away\";\nreturn msg;","outputs":1,"noerr":0,"x":374,"y":228,"wires":[["b6fec28.4f4f9c","eb671eee.ca1368","ccb2ac63.63d3b8"]]},{"id":"6a18c4ab.8953cc","type":"inject","z":"98938126.60692","name":"Here","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":145.5,"y":356,"wires":[["f11632d2.ab4d6"]]},{"id":"f11632d2.ab4d6","type":"function","z":"98938126.60692","name":"","func":"//msg.payload = JSON.stringify({\"status\":\"here\"});\nmsg.payload = {\n    \"status\":\"here\"\n};\n\n//msg.payload = \"away\";\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":360,"wires":[["b6fec28.4f4f9c","eb671eee.ca1368"]]},{"id":"db374913.980e8","type":"inject","z":"98938126.60692","name":"Message","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":152.5,"y":468,"wires":[["5220cf86.35e9e"]]},{"id":"5220cf86.35e9e","type":"function","z":"98938126.60692","name":"","func":"//msg.payload = JSON.stringify({\"status\":\"message\"});\n\nmsg.payload = {\n    \"status\":\"message\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":500,"wires":[["b6fec28.4f4f9c","eb671eee.ca1368"]]},{"id":"89b232b.e2fef5","type":"http in","z":"98938126.60692","name":"","url":"/status/away","method":"get","swaggerDoc":"","x":153,"y":181,"wires":[["28443df5.09bcb2","3688bdbb.f0e86a"]]},{"id":"982e9a9c.92b58","type":"http in","z":"98938126.60692","name":"","url":"/status/here","method":"get","swaggerDoc":"","x":125,"y":302,"wires":[["f11632d2.ab4d6","66b8e71f.7b51d8"]]},{"id":"3688bdbb.f0e86a","type":"http response","z":"98938126.60692","name":"","x":350,"y":120,"wires":[]},{"id":"66b8e71f.7b51d8","type":"http response","z":"98938126.60692","name":"","x":328,"y":301,"wires":[]},{"id":"610bb554.d333d4","type":"function","z":"c210a0c6.d2662","name":"Retrieve Climate History","func":"var deviceId = msg.req.headers['deviceid'];\n\nvar sql = \"SELECT * FROM CLIMATE WHERE DEVICEID='\"+deviceId+\"' ORDER BY DATEMEASURED DESC LIMIT 8;\";\n\nmsg.payload = sql;\n\nreturn msg;\n","outputs":1,"noerr":0,"x":390,"y":420,"wires":[["8c033d0b.68b608"]]},{"id":"52ab10ad.4494e8","type":"http in","z":"c210a0c6.d2662","name":"","url":"/climate","method":"get","swaggerDoc":"","x":127,"y":407,"wires":[["610bb554.d333d4"]]},{"id":"8c033d0b.68b608","type":"dashDB in","z":"c210a0c6.d2662","dashDB":"5dbe8911.6bafb8","service":"_ext_","query":"","params":"","name":"","x":444,"y":484,"wires":[["d1d2af2a.66526"]]},{"id":"a79afcd1.dc395","type":"http response","z":"c210a0c6.d2662","name":"","x":763,"y":589,"wires":[]},{"id":"d1d2af2a.66526","type":"function","z":"c210a0c6.d2662","name":"Format responses","func":"var readings = [];\nvar rawReadings = msg.payload;\n\nif (Object.prototype.toString.call(rawReadings) === '[object Array]') {\n\n    node.warn(\"it is an array of length=\"+rawReadings.length);\n    for (i=0; i < rawReadings.length; i++) {\n        readings.push({\n            dateMeasured: rawReadings[i].DATEMEASURED,\n            temperature: parseFloat(rawReadings[i].TEMPERATURE),\n            humidity: parseFloat(rawReadings[i].HUMIDITY),\n            heatIndex: parseFloat(rawReadings[i].HEATINDEX)\n        })\n    }\n} else {\n    node.warn(\"it is NOT an array\");\n    readings.push({\n        dateMeasured: rawReadings.DATEMEASURED,\n        temperature: parseFloat(rawReadings.TEMPERATURE),\n        humidity: parseFloat(rawReadings.HUMIDITY),\n        heatIndex: parseFloat(rawReadings.HEATINDEX)\n    })\n}\n\n\nmsg.payload = readings;            \n\nreturn msg;","outputs":1,"noerr":0,"x":489,"y":572,"wires":[["a79afcd1.dc395","c5fbb676.0aed"]]},{"id":"c5fbb676.0aed","type":"debug","z":"c210a0c6.d2662","name":"","active":true,"console":"false","complete":"false","x":664,"y":493,"wires":[]},{"id":"eb671eee.ca1368","type":"function","z":"98938126.60692","name":"Insert or update device status","func":"var status = 1;\n\n// msg.payload = {\n//     \"deviceStatus\":\"message\"\n// };\n\nswitch (msg.payload.status) {\n    case \"away\":\n        status = 2;\n        break;\n    case \"here\":\n        status = 1;\n        break;\n    case \"message\":\n        status = 3;\n        break;\n    default:\n        status = 2;\n}\n\nnode.warn(\"msg.payload.status ==\"+msg.payload.status+\" and status=\"+status);\nvar sql = \"MERGE INTO STATUS AS TARGET \";\nsql += \"USING (VALUES ('NODEMCU1001',\"+status+\"))\";\nsql += \"AS SOURCE (DEVICEID,STATUS)\";\nsql += \"ON TARGET.DEVICEID=SOURCE.DEVICEID \";\nsql += \"WHEN MATCHED THEN \";\nsql += \"UPDATE SET \";\nsql += \"STATUS=SOURCE.STATUS \";\nsql += \"WHEN NOT MATCHED THEN \";\nsql += \"INSERT (DEVICEID,STATUS) VALUES (SOURCE.DEVICEID,SOURCE.STATUS);\"\n\nmsg.payload = sql;\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":260,"wires":[["24818460.be4014","b838cfa7.db7c2"]]},{"id":"b838cfa7.db7c2","type":"dashDB in","z":"98938126.60692","dashDB":"5dbe8911.6bafb8","service":"_ext_","query":"","params":"","name":"","x":780,"y":320,"wires":[[]]},{"id":"24818460.be4014","type":"debug","z":"98938126.60692","name":"","active":true,"console":"false","complete":"false","x":790,"y":140,"wires":[]},{"id":"ccb2ac63.63d3b8","type":"debug","z":"98938126.60692","name":"","active":true,"console":"false","complete":"true","x":514.5,"y":153,"wires":[]},{"id":"b176785e.c546d","type":"http in","z":"98938126.60692","name":"","url":"/status","method":"get","upload":false,"swaggerDoc":"","x":106.5,"y":722,"wires":[["bea2715e.b152a"]]},{"id":"bea2715e.b152a","type":"function","z":"98938126.60692","name":"Query device status","func":"var sql = \"SELECT * FROM STATUS WHERE DEVICEID='NODEMCU1001';\";\n\nmsg.payload = sql;\nreturn msg;","outputs":1,"noerr":0,"x":316.5,"y":722,"wires":[["650ff334.36baec"]]},{"id":"650ff334.36baec","type":"dashDB in","z":"98938126.60692","dashDB":"5dbe8911.6bafb8","service":"_ext_","query":"","params":"","name":"","x":356.5,"y":802,"wires":[["a1dfcbe.e13f6b8","69e2ce30.cfdcf"]]},{"id":"5aec83bb.339eec","type":"function","z":"98938126.60692","name":"Map response","func":"var finalPayload = {\n    \"status\":msg.payload.STATUS\n}\nmsg.payload = finalPayload;\nreturn msg;","outputs":1,"noerr":0,"x":696.5,"y":782,"wires":[["2a946d94.56908a","42974dcd.677914"]]},{"id":"a1dfcbe.e13f6b8","type":"switch","z":"98938126.60692","name":"Is error?","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","outputs":2,"x":516.5,"y":802,"wires":[["5aec83bb.339eec"],["1bd388f8.e55067"]]},{"id":"1bd388f8.e55067","type":"function","z":"98938126.60692","name":"Return 404 not found","func":"msg.statusCode = 404;\n\nreturn msg;","outputs":1,"noerr":0,"x":616.5,"y":882,"wires":[["d682c.8dcd27d48"]]},{"id":"d682c.8dcd27d48","type":"http response","z":"98938126.60692","name":"","statusCode":"","headers":{},"x":806.5,"y":882,"wires":[]},{"id":"2a946d94.56908a","type":"http response","z":"98938126.60692","name":"","statusCode":"","headers":{},"x":826.5,"y":822,"wires":[]},{"id":"682c468e.62693","type":"inject","z":"98938126.60692","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":119,"y":786,"wires":[["bea2715e.b152a"]]},{"id":"69e2ce30.cfdcf","type":"debug","z":"98938126.60692","name":"","active":true,"console":"false","complete":"false","x":575,"y":734,"wires":[]},{"id":"42974dcd.677914","type":"debug","z":"98938126.60692","name":"","active":true,"console":"false","complete":"false","x":850,"y":740,"wires":[]},{"id":"396f062.7d887fa","type":"ibmiot in","z":"98938126.60692","authentication":"apiKey","apiKey":"e811d034.2110a","inputType":"evt","deviceId":"","applicationId":"","deviceType":"+","eventType":"requestStatus","commandType":"","format":"json","name":"Request status","service":"registered","allDevices":true,"allApplications":"","allDeviceTypes":true,"allEvents":false,"allCommands":"","allFormats":true,"qos":0,"x":140,"y":1180,"wires":[["86068452.d2e968","3ca260d0.8adca"]]},{"id":"86068452.d2e968","type":"function","z":"98938126.60692","name":"Query device status","func":"var sql = \"SELECT * FROM STATUS WHERE DEVICEID='NODEMCU1001';\";\n\nmsg.payload = sql;\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":1180,"wires":[["ae1c135b.bac73"]]},{"id":"ae1c135b.bac73","type":"dashDB in","z":"98938126.60692","dashDB":"5dbe8911.6bafb8","service":"_ext_","query":"","params":"","name":"","x":440,"y":1260,"wires":[["ed5146bf.a72ab","97c248c0.49b008"]]},{"id":"c8014561.413298","type":"function","z":"98938126.60692","name":"Map response","func":"\nvar status;\n\nswitch (msg.payload.STATUS) {\n    case 2:\n        status=\"away\";\n        break;\n    case 1:\n        status=\"here\";\n        break;\n    case 3:\n        status=\"message\";\n        break;\n    default:\n        status=\"message\";\n}\n\nvar finalPayload = {\n    \"status\":status\n}\nmsg.payload = finalPayload;\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":1200,"wires":[["4c0f54f9.2d893c","fb95bf36.e5a0f"]]},{"id":"ed5146bf.a72ab","type":"switch","z":"98938126.60692","name":"Is error?","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","outputs":2,"x":600,"y":1260,"wires":[["c8014561.413298"],["ecb79b7e.f21b98"]]},{"id":"97c248c0.49b008","type":"debug","z":"98938126.60692","name":"","active":true,"console":"false","complete":"false","x":630,"y":1120,"wires":[]},{"id":"114c79b.c930d06","type":"ibmiot in","z":"40f06183.fb05b","authentication":"apiKey","apiKey":"e811d034.2110a","inputType":"evt","deviceId":"","applicationId":"","deviceType":"+","eventType":"requestJoke","commandType":"","format":"json","name":"Request random joke","service":"registered","allDevices":true,"allApplications":"","allDeviceTypes":true,"allEvents":false,"allCommands":"","allFormats":true,"qos":0,"x":140,"y":120,"wires":[["76b17520.cd0b64"]]},{"id":"76b17520.cd0b64","type":"function","z":"40f06183.fb05b","name":"Select random Chuck Norris joke","func":"// Select a random chuck norris joke\n\nvar sql = 'select *, rand() as idx from jokes order by idx fetch first 1 rows only;';\n\nmsg.payload = sql;\nreturn msg;\n","outputs":1,"noerr":0,"x":400,"y":160,"wires":[["4817e8f9.d866c8"]]},{"id":"4817e8f9.d866c8","type":"dashDB in","z":"40f06183.fb05b","dashDB":"5dbe8911.6bafb8","service":"_ext_","query":"","params":"","name":"","x":450.5,"y":232,"wires":[["4237b695.41237"]]},{"id":"4237b695.41237","type":"function","z":"40f06183.fb05b","name":"Format responses","func":"var joke = msg.payload.JOKETEXT;\n\n\nmsg.payload = JSON.stringify({\"joke\":joke});\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":300,"wires":[["750e1d58.553204","5df51dba.25761c"]]},{"id":"750e1d58.553204","type":"debug","z":"40f06183.fb05b","name":"","active":true,"console":"false","complete":"false","x":742.5,"y":303,"wires":[]},{"id":"a8e28cb3.ed24f8","type":"inject","z":"40f06183.fb05b","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":160.5,"y":209,"wires":[["76b17520.cd0b64"]]},{"id":"5df51dba.25761c","type":"ibmiot out","z":"40f06183.fb05b","authentication":"apiKey","apiKey":"e811d034.2110a","outputType":"cmd","deviceId":"nodemcu1001","deviceType":"esp8266","eventCommandType":"joke","format":"json","data":"{\"joke\":\"Why did the chicken cross the road? To go to the other side\"}","qos":0,"name":"IBM IoT","service":"registered","x":740,"y":360,"wires":[]},{"id":"4c0f54f9.2d893c","type":"ibmiot out","z":"98938126.60692","authentication":"apiKey","apiKey":"e811d034.2110a","outputType":"cmd","deviceId":"nodemcu1001","deviceType":"esp8266","eventCommandType":"indicator","format":"json","data":"{\"status\":\"away\"}","qos":0,"name":"IBM IoT","service":"registered","x":900,"y":1260,"wires":[]},{"id":"ecb79b7e.f21b98","type":"debug","z":"98938126.60692","name":"","active":true,"console":"false","complete":"false","x":770,"y":1380,"wires":[]},{"id":"3ca260d0.8adca","type":"debug","z":"98938126.60692","name":"","active":true,"console":"false","complete":"false","x":371.5,"y":1129,"wires":[]},{"id":"fb95bf36.e5a0f","type":"debug","z":"98938126.60692","name":"","active":true,"console":"false","complete":"false","x":912.5,"y":1156,"wires":[]},{"id":"7ddae115.27d2","type":"comment","z":"98938126.60692","name":"Device request last known status","info":"This flow allows the the device to request the last known status that was set. It is requested during the setup routine so the device knows which status to show after a restart. ","x":170,"y":1060,"wires":[]},{"id":"b5d45425.e0fde","type":"comment","z":"98938126.60692","name":"App request last known status","info":"Allows for the mobile app to request the last known status","x":160,"y":660,"wires":[]},{"id":"48d7ebad.85c90c","type":"comment","z":"98938126.60692","name":"Set status","info":"Allows for the mobile app to set the status and to notify the device of the new status. It will also record the status to the database. ","x":120,"y":60,"wires":[]},{"id":"7dad4a82.e4f46c","type":"inject","z":"e4bbc226.91eb88","name":"30 minute interval trigger","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":true,"x":170,"y":140,"wires":[["b584684.f828c98"]]},{"id":"b584684.f828c98","type":"function","z":"e4bbc226.91eb88","name":"","func":"// msg.headers[\"Accept\"] = \"application/json\";\n// msg.headers[\"Authorization\"] = \"Bearer eyJraWQiOiJRRFFQWDZVSDlQRExOOU9GQVowMlNFRFVYIiwic3R0IjoiYWNjZXNzIiwiYWxnIjoiSFMyNTYifQ.eyJqdGkiOiIxOE1YZ2JtYmlHcTVTdWtpV1l1Nnp4IiwiaWF0IjoxNDkxNTM4NjYzLCJpc3MiOiJodHRwczovL2FwaS5zdG9ybXBhdGguY29tL3YxL2FwcGxpY2F0aW9ucy80QXk3eUYybVFDaUJacVB6OUN5UVU4Iiwic3ViIjoiaHR0cHM6Ly9hcGkuc3Rvcm1wYXRoLmNvbS92MS9hY2NvdW50cy8xNmdpNVc1d1YzTFRjUENERzJ0c094IiwiZXhwIjoxNTU0NjEwNjYzfQ.OeMh0rv5-B5OBKtZZ_vE5f-Ke84QmHUTn5gE6RVpV9E\";\nmsg.headers = {\n    \"Accept\":\"application/json\",\n    \"Authorization\":\"Bearer eyJraWQiOiJRRFFQWDZVSDlQRExOOU9GQVowMlNFRFVYIiwic3R0IjoiYWNjZXNzIiwiYWxnIjoiSFMyNTYifQ.eyJqdGkiOiIxOE1YZ2JtYmlHcTVTdWtpV1l1Nnp4IiwiaWF0IjoxNDkxNTM4NjYzLCJpc3MiOiJodHRwczovL2FwaS5zdG9ybXBhdGguY29tL3YxL2FwcGxpY2F0aW9ucy80QXk3eUYybVFDaUJacVB6OUN5UVU4Iiwic3ViIjoiaHR0cHM6Ly9hcGkuc3Rvcm1wYXRoLmNvbS92MS9hY2NvdW50cy8xNmdpNVc1d1YzTFRjUENERzJ0c094IiwiZXhwIjoxNTU0NjEwNjYzfQ.OeMh0rv5-B5OBKtZZ_vE5f-Ke84QmHUTn5gE6RVpV9E\"\n}\n\nmsg.urlParams = \"VERSION=2.0.0&exceptions=application%2Fjson&REQUEST=GetFeature&SERVICE=WFS&typeNames=vicroads:bluetooth_links&srs=EPSG:35459&outputFormat=application%2Fjson&propertyName=linkid,name,direction,travel_time&featureID=bluetooth_links.1716,bluetooth_links.373,bluetooth_links.505,bluetooth_links.1019,bluetooth_links.1020,bluetooth_links.113,bluetooth_links.793,bluetooth_links.1393,bluetooth_links.1472,bluetooth_links.124,bluetooth_links.231,bluetooth_links.233,bluetooth_links.120,bluetooth_links.1636,bluetooth_links.1637\";\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":140,"wires":[["f62a3091.300ec8"]]},{"id":"f62a3091.300ec8","type":"http request","z":"e4bbc226.91eb88","name":"VicRoads API","method":"GET","ret":"obj","url":"http://api.vicroads.vic.gov.au/vicroads/wfs?{{{urlParams}}}","tls":"","x":600,"y":140,"wires":[["a884944b.34b088","fc4e0601.3dbc98"]]},{"id":"a884944b.34b088","type":"debug","z":"e4bbc226.91eb88","name":"","active":true,"console":"false","complete":"false","x":803.5,"y":140,"wires":[]},{"id":"fc4e0601.3dbc98","type":"function","z":"e4bbc226.91eb88","name":"Calculate Travel Time","func":"var response = msg.payload;\n\nnode.warn(\"113 traveltime = \"+response.features[0].properties.travel_time);\n\nvar totalTravelTime = 0;\n\nfor (i=0; i< response.features.length; i++) {\n    totalTravelTime += response.features[i].properties.travel_time;    \n}\n\ntotalTravelTime = Math.round(totalTravelTime);\n\nnode.warn(\"total travelTime = \"+totalTravelTime);\n\nmsg.payload = totalTravelTime;\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":240,"wires":[["355f06c2.819dba"]]},{"id":"355f06c2.819dba","type":"function","z":"e4bbc226.91eb88","name":"Format responses","func":"var travelTime = msg.payload;\n\n//msg.payload = JSON.stringify({\"travelTime\":travelTime});\n\nmsg.payload = {\n    \"travelTime\":travelTime\n}\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":240,"wires":[["6236c6eb.6d3fa","5c18f13f.18c468"]]},{"id":"6236c6eb.6d3fa","type":"debug","z":"e4bbc226.91eb88","name":"","active":true,"console":"false","complete":"false","x":1010,"y":300,"wires":[]},{"id":"5c18f13f.18c468","type":"ibmiot out","z":"e4bbc226.91eb88","authentication":"apiKey","apiKey":"e811d034.2110a","outputType":"cmd","deviceId":"nodemcu1001","deviceType":"esp8266","eventCommandType":"travelTime","format":"json","data":"{\"travelTime\":35}","qos":0,"name":"IBM IoT","service":"registered","x":760,"y":380,"wires":[]},{"id":"4bedfb29.e36fec","type":"weather_insights","z":"f5277bd.7bb7c08","name":"Currnet Observations","host":"twcservice.mybluemix.net","service":"/observations.json","geocode":"-37.821195,144.966166","units":"m","language":"","x":460,"y":100,"wires":[["f94c5edc.0dbf38","93cd2615.fdd998","99e87bcf.1842b","a36d10d0.599548"]]},{"id":"f94c5edc.0dbf38","type":"debug","z":"f5277bd.7bb7c08","name":"","active":true,"console":"false","complete":"observation","x":810,"y":540,"wires":[]},{"id":"93cd2615.fdd998","type":"debug","z":"f5277bd.7bb7c08","name":"","active":true,"console":"false","complete":"observations","x":810,"y":600,"wires":[]},{"id":"99e87bcf.1842b","type":"debug","z":"f5277bd.7bb7c08","name":"","active":true,"console":"false","complete":"false","x":774.5,"y":663,"wires":[]},{"id":"a9aa19f7.b052b","type":"debug","z":"f5277bd.7bb7c08","name":"","active":true,"console":"false","complete":"false","x":990,"y":340,"wires":[]},{"id":"4a285730.3287c","type":"inject","z":"f5277bd.7bb7c08","name":"30 minute interval trigger","topic":"","payload":"-37.821195,144.966166","payloadType":"str","repeat":"300","crontab":"","once":true,"x":210,"y":100,"wires":[["4bedfb29.e36fec"]]},{"id":"a36d10d0.599548","type":"function","z":"f5277bd.7bb7c08","name":"Format responses","func":"var observation = msg.observation;\n\n//msg.payload = JSON.stringify({\"travelTime\":travelTime});\n\nmsg.payload = {\n    \"outsideClimate\":{\n        \"outsideTemp\":observation.temp,\n        \"outsideHumid\":observation.rh\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":120,"wires":[["a9aa19f7.b052b","b1597b4e.497d08"]]},{"id":"b1597b4e.497d08","type":"ibmiot out","z":"f5277bd.7bb7c08","authentication":"apiKey","apiKey":"e811d034.2110a","outputType":"cmd","deviceId":"nodemcu1001","deviceType":"esp8266","eventCommandType":"outsideClimate","format":"json","data":"{\"outsideClimate\":{\"outsideTemp\":21,\"outsideHumid\":60}}","qos":0,"name":"IBM IoT","service":"registered","x":760,"y":400,"wires":[]}]